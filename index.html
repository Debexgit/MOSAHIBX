<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ูุตุงุญุจ: ูุณุงุนุฏู ุงูุชุฑุจูู ุงูุฐูู</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Cairo', sans-serif;
            direction: rtl;
            background-color: #f8fafc;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #14b8a6;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .gemini-tab {
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
            color: #6b7280;
        }
        .gemini-tab.active, .gemini-tab:hover {
            border-bottom-color: #14b8a6;
            color: #14b8a6;
        }
    </style>
</head>
<body class="bg-slate-50 text-gray-800">

    <div class="container mx-auto max-w-5xl p-4 sm:p-6 md:p-8">

        <header class="text-center mb-12">
            <h1 class="text-4xl md:text-6xl font-extrabold text-gray-900 leading-tight">ูุตุงุญุจ</h1>
            <h2 class="text-2xl md:text-3xl font-bold text-teal-600 mt-2">ูุณุงุนุฏู ุงูุชุฑุจูู ุงูุฐูู</h2>
            <p class="mt-4 text-lg text-gray-600 max-w-2xl mx-auto">ุฃุฏูุงุช ุฐููุฉ ุจูู ูุฏูู ูุชุณููู ููุงูู ุงูุชุฑุจููุฉ ุงูููููุฉ.</p>
        </header>

        <main>

            <section id="gemini-assistant">
                <div class="bg-white rounded-2xl shadow-xl p-6 md:p-8 text-center">
                     <h2 class="text-3xl font-bold text-teal-600 mb-4">๐ค ุงุฎุชุฑ ุฃุฏุงุชู ุงูุฐููุฉ</h2>
                     <p class="text-lg text-gray-700 max-w-3xl mx-auto mb-8">
                        ุฃุฏูุงุช ุฅุจุฏุงุนูุฉ ุชุญุช ุชุตุฑูู. ุงุฎุชุฑ ุฅุญุฏู ุงูููุงู ุฃุฏูุงู ูุฏุน ุงูุฐูุงุก ุงูุงุตุทูุงุนู ูุณุงุนุฏู ูู ุงูุชุฎุทูุท ูุงูุฅุจุฏุงุน.
                    </p>
                    <div class="border-b border-gray-200">
                        <div class="flex flex-wrap justify-center -mb-px gap-2 md:gap-4">
                            <button data-modal="unit" class="gemini-tab font-semibold text-lg py-3 px-4">๐ ูุฎุทุท ุงููุญุฏุงุช</button>
                            <button data-modal="lesson" class="gemini-tab font-semibold text-lg py-3 px-4">โจ ุงูุฏุฑูุณ</button>
                            <button data-modal="objectives" class="gemini-tab font-semibold text-lg py-3 px-4">๐ฏ ุงูุฃูุฏุงู</button>
                            <button data-modal="activity" class="gemini-tab font-semibold text-lg py-3 px-4">๐ก ุงูุฃูุดุทุฉ</button>
                            <button data-modal="questions" class="gemini-tab font-semibold text-lg py-3 px-4">๐ค ุฃุณุฆูุฉ</button>
                            <button data-modal="transition" class="gemini-tab font-semibold text-lg py-3 px-4">๐ ุงูุงูุชูุงูุงุช</button>
                            <button data-modal="song" class="gemini-tab font-semibold text-lg py-3 px-4">๐ถ ุงูุฃูุงุดูุฏ</button>
                            <button data-modal="story" class="gemini-tab font-semibold text-lg py-3 px-4">๐ ุงููุตุต</button>
                            <button data-modal="conflict" class="gemini-tab font-semibold text-lg py-3 px-4">๐ฃ๏ธ ุงููุฒุงุนุงุช</button>
                            <button data-modal="observation" class="gemini-tab font-semibold text-lg py-3 px-4">๐ ุงูููุงุญุธุงุช</button>
                            <button data-modal="communication" class="gemini-tab font-semibold text-lg py-3 px-4">โ๏ธ ุฑุณุงุฆู</button>
                            <button data-modal="summary" class="gemini-tab font-semibold text-lg py-3 px-4">๐ ุงูููุฎุต</button>
                            <button data-modal="support" class="gemini-tab font-semibold text-lg py-3 px-4">๐ค ุงูุฏุนู</button>
                        </div>
                    </div>
                </div>
            </section>
            
        </main>
        
        <footer class="text-center mt-16 pt-8 border-t border-gray-200">
             <p class="text-gray-600 font-semibold">Debex &copy; 2025</p>
        </footer>

    </div>
    
    <div data-modal-id="unit" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-lg p-6 relative">
            <button data-close-button class="absolute top-3 right-3 text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
            <h3 class="text-2xl font-bold text-center mb-4 text-teal-600">ูุฎุทุท ุงููุญุฏุงุช ุงูุฏุฑุงุณูุฉ</h3>
            <form id="unitForm">
                 <div class="mb-4">
                    <label for="unitTheme" class="block text-gray-700 text-sm font-bold mb-2">ููุถูุน ุงููุญุฏุฉ:</label>
                    <input type="text" id="unitTheme" placeholder="ูุซุงู: ุนุงูู ุงูุฏููุงุตูุฑุงุชุ ุงููุตูู ุงูุฃุฑุจุนุฉ..." class="shadow-sm appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-teal-500">
                </div>
                <div class="mb-6">
                    <label for="unitDuration" class="block text-gray-700 text-sm font-bold mb-2">ุงููุฏุฉ ุงูุฒูููุฉ:</label>
                    <select id="unitDuration" class="block appearance-none w-full bg-gray-100 border border-gray-200 text-gray-700 py-3 px-4 pr-8 rounded-lg leading-tight focus:outline-none focus:bg-white focus:border-gray-500">
                        <option value="3 ุฃูุงู">3 ุฃูุงู</option>
                        <option value="ุฃุณุจูุน ูุงุญุฏ">ุฃุณุจูุน ูุงุญุฏ</option>
                        <option value="ุฃุณุจูุนูู">ุฃุณุจูุนูู</option>
                    </select>
                </div>
                <div class="text-center">
                    <button type="submit" class="bg-teal-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-teal-600 transition-colors">
                        โจ ุฅูุดุงุก ุงููุฎุทุท
                    </button>
                </div>
            </form>
            <div id="unitResult" class="mt-6 hidden">
                <div class="flex justify-between items-center mb-2">
                    <h4 class="text-xl font-bold text-gray-800">ูุฎุทุท ุงููุญุฏุฉ ุงูููุชุฑุญ:</h4>
                    <button class="copy-btn bg-slate-200 text-slate-700 text-sm py-1 px-3 rounded-md hover:bg-slate-300">ูุณุฎ ุงููุต</button>
                </div>
                <div id="unitLoader" class="loader mx-auto my-4 hidden"></div>
                <pre id="unitResultText" class="bg-slate-100 p-4 rounded-lg whitespace-pre-wrap text-right font-sans"></pre>
            </div>
        </div>
    </div>
    <div data-modal-id="activity" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-lg p-6 relative">
            <button data-close-button class="absolute top-3 right-3 text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
            <h3 class="text-2xl font-bold text-center mb-4 text-teal-600">ุชูููุฏ ููุฑุฉ ูุดุงุท</h3>
            <form id="activityForm">
                <div class="mb-4">
                    <label for="activityType" class="block text-gray-700 text-sm font-bold mb-2">ููุน ุงููุดุงุท:</label>
                    <select id="activityType" class="block appearance-none w-full bg-gray-100 border border-gray-200 text-gray-700 py-3 px-4 pr-8 rounded-lg leading-tight focus:outline-none focus:bg-white focus:border-gray-500">
                        <option value="ูุนุจุฉ ุญุฑููุฉ">ูุนุจุฉ ุญุฑููุฉ</option>
                        <option value="ุฃูุดูุฏุฉ ุจุณูุทุฉ">ุฃูุดูุฏุฉ ุจุณูุทุฉ</option>
                        <option value="ูุดุงุท ููู">ูุดุงุท ููู</option>
                    </select>
                </div>
                <div class="mb-6">
                    <label for="activityTheme" class="block text-gray-700 text-sm font-bold mb-2">ููุถูุน ุงููุดุงุท:</label>
                    <input type="text" id="activityTheme" placeholder="ูุซุงู: ุงูููุงููุ ุงูุญููุงูุงุชุ ุงููุถุงุก" class="shadow-sm appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-teal-500">
                </div>
                <div class="text-center">
                    <button type="submit" class="bg-teal-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-teal-600 transition-colors">
                        โจ ุชูููุฏ ุงูููุฑุฉ
                    </button>
                </div>
            </form>
            <div id="activityResult" class="mt-6 hidden">
                <h4 class="text-xl font-bold text-gray-800 mb-2">ุงูููุฑุฉ ุงูููุชุฑุญุฉ:</h4>
                <div id="activityLoader" class="loader mx-auto my-4 hidden"></div>
                <pre id="activityResultText" class="bg-slate-100 p-4 rounded-lg whitespace-pre-wrap text-right font-sans"></pre>
            </div>
        </div>
    </div>
    <div data-modal-id="communication" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-lg p-6 relative">
            <button data-close-button class="absolute top-3 right-3 text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
            <h3 class="text-2xl font-bold text-center mb-4 text-teal-600">ุตูุงุบุฉ ุฑุณุงูุฉ ูููู ุงูุฃูุฑ</h3>
            <form id="communicationForm">
                <div class="mb-4">
                     <label for="commTone" class="block text-gray-700 text-sm font-bold mb-2">ูุจุฑุฉ ุงูุฑุณุงูุฉ:</label>
                    <select id="commTone" class="block appearance-none w-full bg-gray-100 border border-gray-200 text-gray-700 py-3 px-4 pr-8 rounded-lg leading-tight focus:outline-none focus:bg-white focus:border-gray-500">
                        <option value="ุชุญุฏูุซ ุฅูุฌุงุจู">ุชุญุฏูุซ ุฅูุฌุงุจู</option>
                        <option value="ููุงุญุธุฉ ุจุณูุทุฉ">ููุงุญุธุฉ ุจุณูุทุฉ</option>
                        <option value="ุงุทูุฆูุงู ุนุงู">ุงุทูุฆูุงู ุนุงู</option>
                    </select>
                </div>
                <div class="mb-6">
                    <label for="commPoints" class="block text-gray-700 text-sm font-bold mb-2">ููุงุท ุฑุฆูุณูุฉ ุนู ููู ุงูุทูู:</label>
                    <textarea id="commPoints" rows="4" placeholder="ูุซุงู: ูุงู ุณุนูุฏูุง ุงููููุ ุดุงุฑู ุฃูุนุงุจู ูุน ุฒููุงุฆูุ ุงุณุชูุชุน ุจุฏุฑุณ ุงูุฑุณู..." class="shadow-sm appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-teal-500"></textarea>
                </div>
                <div class="text-center">
                    <button type="submit" class="bg-teal-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-teal-600 transition-colors">
                        โจ ุตูุงุบุฉ ุงูุฑุณุงูุฉ
                    </button>
                </div>
            </form>
            <div id="communicationResult" class="mt-6 hidden">
                <div class="flex justify-between items-center mb-2">
                    <h4 class="text-xl font-bold text-gray-800">ุงูุฑุณุงูุฉ ุงูููุชุฑุญุฉ:</h4>
                    <button class="copy-btn bg-slate-200 text-slate-700 text-sm py-1 px-3 rounded-md hover:bg-slate-300">ูุณุฎ ุงููุต</button>
                </div>
                <div id="commLoader" class="loader mx-auto my-4 hidden"></div>
                <pre id="commResultText" class="bg-slate-100 p-4 rounded-lg whitespace-pre-wrap text-right font-sans"></pre>
            </div>
        </div>
    </div>
    <div data-modal-id="story" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-lg p-6 relative">
            <button data-close-button class="absolute top-3 right-3 text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
            <h3 class="text-2xl font-bold text-center mb-4 text-teal-600">ุฅูุดุงุก ูุตุฉ ูุตูุฑุฉ</h3>
            <form id="storyForm">
                <div class="mb-4">
                    <label for="storyCharacter" class="block text-gray-700 text-sm font-bold mb-2">ุงุณู ุงูุดุฎุตูุฉ ุงูุฑุฆูุณูุฉ:</label>
                    <input type="text" id="storyCharacter" placeholder="ูุซุงู: ููุฑุฉุ ุงูุฃุฑูุจ ุงูุณุฑูุน" class="shadow-sm appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-teal-500">
                </div>
                <div class="mb-6">
                    <label for="storyTheme" class="block text-gray-700 text-sm font-bold mb-2">ููุถูุน ุงููุตุฉ:</label>
                    <input type="text" id="storyTheme" placeholder="ูุซุงู: ุงูุตุฏุงูุฉุ ูุณุงุนุฏุฉ ุงูุขุฎุฑูู" class="shadow-sm appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-teal-500">
                </div>
                <div class="text-center">
                    <button type="submit" class="bg-teal-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-teal-600 transition-colors">
                        โจ ุชูููุฏ ุงููุตุฉ
                    </button>
                </div>
            </form>
            <div id="storyResult" class="mt-6 hidden">
                 <div class="flex justify-between items-center mb-2">
                    <h4 class="text-xl font-bold text-gray-800">ุงููุตุฉ:</h4>
                    <button class="copy-btn bg-slate-200 text-slate-700 text-sm py-1 px-3 rounded-md hover:bg-slate-300">ูุณุฎ ุงููุต</button>
                </div>
                <div id="storyLoader" class="loader mx-auto my-4 hidden"></div>
                <pre id="storyResultText" class="bg-slate-100 p-4 rounded-lg whitespace-pre-wrap text-right font-sans"></pre>
                <div class="text-center mt-4">
                     <button id="generateImageBtn" class="bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors hidden">
                        ๐จ ุชูููุฏ ุตูุฑุฉ ูููุตุฉ
                    </button>
                </div>
                <div id="imageResult" class="mt-4 text-center hidden">
                     <div id="imageLoader" class="loader mx-auto my-4 hidden"></div>
                     <img id="storyImage" src="" alt="ุตูุฑุฉ ุงููุตุฉ" class="max-w-full mx-auto rounded-lg shadow-md">
                </div>
            </div>
        </div>
    </div>
    <div data-modal-id="summary" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-lg p-6 relative">
            <button data-close-button class="absolute top-3 right-3 text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
            <h3 class="text-2xl font-bold text-center mb-4 text-teal-600">ุฅูุดุงุก ููุฎุต ุงูููู</h3>
            <form id="summaryForm">
                <div class="mb-6">
                    <label for="summaryPoints" class="block text-gray-700 text-sm font-bold mb-2">ุงููููุงุช ุงูุฑุฆูุณูุฉ ูู ุฃูุดุทุฉ ุงูููู:</label>
                    <textarea id="summaryPoints" rows="4" placeholder="ูุซุงู: ุชุนูููุง ุนู ุงูููู ุงูุฃุญูุฑุ ุตูุนูุง ุชูุงุญุฉ ุจุงูุนุฌููุ ุบูููุง ุฃุบููุฉ ุงูููุงูู..." class="shadow-sm appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-teal-500"></textarea>
                </div>
                <div class="text-center">
                    <button type="submit" class="bg-teal-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-teal-600 transition-colors">
                        โจ ุฅูุดุงุก ุงูููุฎุต
                    </button>
                </div>
            </form>
            <div id="summaryResult" class="mt-6 hidden">
                <div class="flex justify-between items-center mb-2">
                    <h4 class="text-xl font-bold text-gray-800">ุงูููุฎุต ุงูููุชุฑุญ:</h4>
                    <button class="copy-btn bg-slate-200 text-slate-700 text-sm py-1 px-3 rounded-md hover:bg-slate-300">ูุณุฎ ุงููุต</button>
                </div>
                <div id="summaryLoader" class="loader mx-auto my-4 hidden"></div>
                <pre id="summaryResultText" class="bg-slate-100 p-4 rounded-lg whitespace-pre-wrap text-right font-sans"></pre>
            </div>
        </div>
    </div>
    <div data-modal-id="support" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-lg p-6 relative">
            <button data-close-button class="absolute top-3 right-3 text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
            <h3 class="text-2xl font-bold text-center mb-4 text-teal-600">ููุฎุทููุท ุงูุฏุนู ุงููุฑุฏู</h3>
            <form id="supportForm">
                <div class="mb-6">
                    <label for="supportNeeds" class="block text-gray-700 text-sm font-bold mb-2">ุตู ุจุงุฎุชุตุงุฑ ุณููู ุฃู ุงุญุชูุงุฌ ุงูุทูู:</label>
                    <textarea id="supportNeeds" rows="4" placeholder="ูุซุงู: ุทูู ุฎุฌูู ูุฑูุถ ุงููุดุงุฑูุฉ ูู ุงูุฃูุดุทุฉ ุงูุฌูุงุนูุฉุ ุทููุฉ ูุซูุฑุฉ ุงูุญุฑูุฉ ูุชููุฏ ุงูุชุฑููุฒ ุจุณุฑุนุฉ..." class="shadow-sm appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-teal-500"></textarea>
                </div>
                <div class="text-center">
                    <button type="submit" class="bg-teal-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-teal-600 transition-colors">
                        โจ ุชูููุฏ ุฎุทุฉ ุงูุฏุนู
                    </button>
                </div>
            </form>
            <div id="supportResult" class="mt-6 hidden">
                <div class="flex justify-between items-center mb-2">
                    <h4 class="text-xl font-bold text-gray-800">ุฎุทุฉ ุงูุฏุนู ุงูููุชุฑุญุฉ:</h4>
                    <button class="copy-btn bg-slate-200 text-slate-700 text-sm py-1 px-3 rounded-md hover:bg-slate-300">ูุณุฎ ุงููุต</button>
                </div>
                <div id="supportLoader" class="loader mx-auto my-4 hidden"></div>
                <pre id="supportResultText" class="bg-slate-100 p-4 rounded-lg whitespace-pre-wrap text-right font-sans"></pre>
            </div>
        </div>
    </div>
    <div data-modal-id="lesson" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-lg p-6 relative">
            <button data-close-button class="absolute top-3 right-3 text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
            <h3 class="text-2xl font-bold text-center mb-4 text-teal-600">ููุฎุทููุท ุงูุฏุฑูุณ</h3>
            <form id="lessonForm">
                 <div class="mb-4">
                    <label for="lessonObjective" class="block text-gray-700 text-sm font-bold mb-2">ุงููุฏู ุงูุชุนูููู:</label>
                    <textarea id="lessonObjective" rows="3" placeholder="ูุซุงู: ุชุนููู ุงูุฃุทูุงู ุงูุนุฏ ูู 1 ุฅูู 5ุ ุชุนุฑูู ุงูุฃุทูุงู ุนูู ุญุฑู ุงูุฃูู..." class="shadow-sm appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-teal-500"></textarea>
                </div>
                <div class="mb-6">
                    <label for="lessonDuration" class="block text-gray-700 text-sm font-bold mb-2">ุงููุฏุฉ ุงูุฒูููุฉ ุงูุชูุฑูุจูุฉ:</label>
                    <select id="lessonDuration" class="block appearance-none w-full bg-gray-100 border border-gray-200 text-gray-700 py-3 px-4 pr-8 rounded-lg leading-tight focus:outline-none focus:bg-white focus:border-gray-500">
                        <option value="15 ุฏูููุฉ">15 ุฏูููุฉ</option>
                        <option value="20 ุฏูููุฉ">20 ุฏูููุฉ</option>
                        <option value="30 ุฏูููุฉ">30 ุฏูููุฉ</option>
                    </select>
                </div>
                <div class="text-center">
                    <button type="submit" class="bg-teal-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-teal-600 transition-colors">
                        โจ ุฅูุดุงุก ุฎุทุฉ ุงูุฏุฑุณ
                    </button>
                </div>
            </form>
            <div id="lessonResult" class="mt-6 hidden">
                <div class="flex justify-between items-center mb-2">
                    <h4 class="text-xl font-bold text-gray-800">ุฎุทุฉ ุงูุฏุฑุณ ุงูููุชุฑุญุฉ:</h4>
                    <button class="copy-btn bg-slate-200 text-slate-700 text-sm py-1 px-3 rounded-md hover:bg-slate-300">ูุณุฎ ุงููุต</button>
                </div>
                <div id="lessonLoader" class="loader mx-auto my-4 hidden"></div>
                <pre id="lessonResultText" class="bg-slate-100 p-4 rounded-lg whitespace-pre-wrap text-right font-sans"></pre>
            </div>
        </div>
    </div>
    <div data-modal-id="song" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-lg p-6 relative">
            <button data-close-button class="absolute top-3 right-3 text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
            <h3 class="text-2xl font-bold text-center mb-4 text-teal-600">ููููุฏ ุงูุฃูุงุดูุฏ</h3>
            <form id="songForm">
                 <div class="mb-6">
                    <label for="songTheme" class="block text-gray-700 text-sm font-bold mb-2">ููุถูุน ุงูุฃูุดูุฏุฉ:</label>
                    <input type="text" id="songTheme" placeholder="ูุซุงู: ุบุณู ุงููุฏููุ ูุตู ุงูุฎุฑููุ ุงูุฃููุงู" class="shadow-sm appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-teal-500">
                </div>
                <div class="text-center">
                    <button type="submit" class="bg-teal-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-teal-600 transition-colors">
                        โจ ูุชุงุจุฉ ุงูุฃูุดูุฏุฉ
                    </button>
                </div>
            </form>
            <div id="songResult" class="mt-6 hidden">
                <div class="flex justify-between items-center mb-2">
                    <h4 class="text-xl font-bold text-gray-800">ุงูุฃูุดูุฏุฉ ุงูููุชุฑุญุฉ:</h4>
                    <button class="copy-btn bg-slate-200 text-slate-700 text-sm py-1 px-3 rounded-md hover:bg-slate-300">ูุณุฎ ุงููุต</button>
                </div>
                <div id="songLoader" class="loader mx-auto my-4 hidden"></div>
                <pre id="songResultText" class="bg-slate-100 p-4 rounded-lg whitespace-pre-wrap text-right font-sans"></pre>
            </div>
        </div>
    </div>
    <div data-modal-id="observation" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-lg p-6 relative">
            <button data-close-button class="absolute top-3 right-3 text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
            <h3 class="text-2xl font-bold text-center mb-4 text-teal-600">ูุณุงุนุฏ ุชุฏููู ุงูููุงุญุธุงุช</h3>
            <form id="observationForm">
                 <div class="mb-6">
                    <label for="observationText" class="block text-gray-700 text-sm font-bold mb-2">ุฃุฏุฎู ููุงุญุธุชู ุงูุณุฑูุนุฉ:</label>
                    <textarea id="observationText" rows="3" placeholder="ูุซุงู: ุณุงุฑุฉ ุฑุณูุช ุฏุงุฆุฑุฉ ูุบููุฉ ูุฃูู ูุฑุฉุ ุนูู ุดุงุฑู ูุนุจุชู ูุน ุตุฏููู..." class="shadow-sm appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-teal-500"></textarea>
                </div>
                <div class="text-center">
                    <button type="submit" class="bg-teal-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-teal-600 transition-colors">
                        โจ ุชุญููู ุฅูู ููุงุญุธุฉ ููููุฉ
                    </button>
                </div>
            </form>
            <div id="observationResult" class="mt-6 hidden">
                <div class="flex justify-between items-center mb-2">
                    <h4 class="text-xl font-bold text-gray-800">ุงูููุงุญุธุฉ ุงูููููุฉ:</h4>
                    <button class="copy-btn bg-slate-200 text-slate-700 text-sm py-1 px-3 rounded-md hover:bg-slate-300">ูุณุฎ ุงููุต</button>
                </div>
                <div id="observationLoader" class="loader mx-auto my-4 hidden"></div>
                <pre id="observationResultText" class="bg-slate-100 p-4 rounded-lg whitespace-pre-wrap text-right font-sans"></pre>
            </div>
        </div>
    </div>
    <div data-modal-id="conflict" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-lg p-6 relative">
            <button data-close-button class="absolute top-3 right-3 text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
            <h3 class="text-2xl font-bold text-center mb-4 text-teal-600">ูุณุงุนุฏ ุญู ุงููุฒุงุนุงุช</h3>
            <form id="conflictForm">
                 <div class="mb-6">
                    <label for="conflictDescription" class="block text-gray-700 text-sm font-bold mb-2">ุตู ุงููุฒุงุน ุจุงุฎุชุตุงุฑ:</label>
                    <textarea id="conflictDescription" rows="3" placeholder="ูุซุงู: ุทููุงู ูุชุดุงุฌุฑุงู ุนูู ููุณ ุงููุนุจุฉุ ุทูู ุฃุฎุฐ ุบุฑุถุงู ูู ุฒูููู..." class="shadow-sm appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-teal-500"></textarea>
                </div>
                <div class="text-center">
                    <button type="submit" class="bg-teal-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-teal-600 transition-colors">
                        โจ ุงูุชุฑุงุญ ุญู
                    </button>
                </div>
            </form>
            <div id="conflictResult" class="mt-6 hidden">
                <div class="flex justify-between items-center mb-2">
                    <h4 class="text-xl font-bold text-gray-800">ุฎุทุฉ ุงูุนูู ุงูููุชุฑุญุฉ:</h4>
                    <button class="copy-btn bg-slate-200 text-slate-700 text-sm py-1 px-3 rounded-md hover:bg-slate-300">ูุณุฎ ุงููุต</button>
                </div>
                <div id="conflictLoader" class="loader mx-auto my-4 hidden"></div>
                <pre id="conflictResultText" class="bg-slate-100 p-4 rounded-lg whitespace-pre-wrap text-right font-sans"></pre>
            </div>
        </div>
    </div>
     <div data-modal-id="objectives" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-lg p-6 relative">
            <button data-close-button class="absolute top-3 right-3 text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
            <h3 class="text-2xl font-bold text-center mb-4 text-teal-600">ูุณุงุนุฏ ุชุญุฏูุฏ ุงูุฃูุฏุงู</h3>
            <form id="objectivesForm">
                 <div class="mb-6">
                    <label for="objectivesActivity" class="block text-gray-700 text-sm font-bold mb-2">ุตู ุงููุดุงุท ุจุงุฎุชุตุงุฑ:</label>
                    <textarea id="objectivesActivity" rows="3" placeholder="ูุซุงู: ุจูุงุก ุจุฑุฌ ุจุงูููุนุจุงุชุ ุชูููู ุฑุณูุฉ ุดุฌุฑุฉุ ุงููุนุจ ุจุงูุฑูู..." class="shadow-sm appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-teal-500"></textarea>
                </div>
                <div class="text-center">
                    <button type="submit" class="bg-teal-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-teal-600 transition-colors">
                        โจ ุชุญุฏูุฏ ุงูุฃูุฏุงู
                    </button>
                </div>
            </form>
            <div id="objectivesResult" class="mt-6 hidden">
                <div class="flex justify-between items-center mb-2">
                    <h4 class="text-xl font-bold text-gray-800">ุงูุฃูุฏุงู ุงูุชุฑุจููุฉ:</h4>
                    <button class="copy-btn bg-slate-200 text-slate-700 text-sm py-1 px-3 rounded-md hover:bg-slate-300">ูุณุฎ ุงููุต</button>
                </div>
                <div id="objectivesLoader" class="loader mx-auto my-4 hidden"></div>
                <pre id="objectivesResultText" class="bg-slate-100 p-4 rounded-lg whitespace-pre-wrap text-right font-sans"></pre>
            </div>
        </div>
    </div>
     <div data-modal-id="questions" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-lg p-6 relative">
            <button data-close-button class="absolute top-3 right-3 text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
            <h3 class="text-2xl font-bold text-center mb-4 text-teal-600">ููููุฏ ุงูุฃุณุฆูุฉ ุงููุญูุฒุฉ</h3>
            <form id="questionsForm">
                 <div class="mb-6">
                    <label for="questionsTopic" class="block text-gray-700 text-sm font-bold mb-2">ุฃุฏุฎู ููุถูุน ุงููุดุงุท ุฃู ุงูุญูุงุฑ:</label>
                    <input type="text" id="questionsTopic" placeholder="ูุซุงู: ุงูุฏููุงุตูุฑุงุชุ ูุทุฑุงุช ุงููุทุฑุ ูุดุงุนุฑ ุงููุฑุญ..." class="shadow-sm appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-teal-500">
                </div>
                <div class="text-center">
                    <button type="submit" class="bg-teal-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-teal-600 transition-colors">
                        โจ ุชูููุฏ ุฃุณุฆูุฉ
                    </button>
                </div>
            </form>
            <div id="questionsResult" class="mt-6 hidden">
                <div class="flex justify-between items-center mb-2">
                    <h4 class="text-xl font-bold text-gray-800">ุฃุณุฆูุฉ ููุชุฑุญุฉ:</h4>
                    <button class="copy-btn bg-slate-200 text-slate-700 text-sm py-1 px-3 rounded-md hover:bg-slate-300">ูุณุฎ ุงููุต</button>
                </div>
                <div id="questionsLoader" class="loader mx-auto my-4 hidden"></div>
                <pre id="questionsResultText" class="bg-slate-100 p-4 rounded-lg whitespace-pre-wrap text-right font-sans"></pre>
            </div>
        </div>
    </div>
    <div data-modal-id="transition" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-lg p-6 relative">
            <button data-close-button class="absolute top-3 right-3 text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
            <h3 class="text-2xl font-bold text-center mb-4 text-teal-600">ูุณุงุนุฏ ุงูุงูุชูุงูุงุช</h3>
            <form id="transitionForm">
                 <div class="mb-6">
                    <label for="transitionDescription" class="block text-gray-700 text-sm font-bold mb-2">ุตู ุงููููู ุงูุงูุชูุงูู:</label>
                    <textarea id="transitionDescription" rows="3" placeholder="ูุซุงู: ุงูุงูุชูุงู ูู ุชุฑุชูุจ ุงูุฃูุนุงุจ ุฅูู ุบุณู ุงููุฏููุ ุงูุงูุชูุงู ูู ุงูุณุงุญุฉ ุฅูู ุงููุณู..." class="shadow-sm appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-teal-500"></textarea>
                </div>
                <div class="text-center">
                    <button type="submit" class="bg-teal-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-teal-600 transition-colors">
                        โจ ุงูุชุฑุงุญ ููุฑุฉ
                    </button>
                </div>
            </form>
            <div id="transitionResult" class="mt-6 hidden">
                <div class="flex justify-between items-center mb-2">
                    <h4 class="text-xl font-bold text-gray-800">ููุฑุฉ ููุชุฑุญุฉ:</h4>
                    <button class="copy-btn bg-slate-200 text-slate-700 text-sm py-1 px-3 rounded-md hover:bg-slate-300">ูุณุฎ ุงููุต</button>
                </div>
                <div id="transitionLoader" class="loader mx-auto my-4 hidden"></div>
                <pre id="transitionResultText" class="bg-slate-100 p-4 rounded-lg whitespace-pre-wrap text-right font-sans"></pre>
            </div>
        </div>
    </div>
    
    <script>
        const apiKey = "";
        const textApiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
        const imageApiUrl = `https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict?key=${apiKey}`;
        
        const modals = document.querySelectorAll('[data-modal-id]');
        const tabs = document.querySelectorAll('.gemini-tab');

        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const modalId = tab.dataset.modal;
                const targetModal = document.querySelector(`[data-modal-id="${modalId}"]`);
                
                tabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                
                if (targetModal) {
                    targetModal.classList.remove('hidden');
                    targetModal.classList.add('flex');
                }
            });
        });

        modals.forEach(modal => {
            const closeButton = modal.querySelector('[data-close-button]');
            closeButton.addEventListener('click', () => {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            });
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.add('hidden');
                    modal.classList.remove('flex');
                }
            });
        });
        
        const forms = {
            activity: document.getElementById('activityForm'),
            communication: document.getElementById('communicationForm'),
            story: document.getElementById('storyForm'),
            summary: document.getElementById('summaryForm'),
            support: document.getElementById('supportForm'),
            lesson: document.getElementById('lessonForm'),
            song: document.getElementById('songForm'),
            observation: document.getElementById('observationForm'),
            conflict: document.getElementById('conflictForm'),
            objectives: document.getElementById('objectivesForm'),
            questions: document.getElementById('questionsForm'),
            unit: document.getElementById('unitForm'),
            transition: document.getElementById('transitionForm')
        };

        const results = {
            activity: document.getElementById('activityResult'),
            communication: document.getElementById('communicationResult'),
            story: document.getElementById('storyResult'),
            summary: document.getElementById('summaryResult'),
            support: document.getElementById('supportResult'),
            lesson: document.getElementById('lessonResult'),
            song: document.getElementById('songResult'),
            observation: document.getElementById('observationResult'),
            conflict: document.getElementById('conflictResult'),
            objectives: document.getElementById('objectivesResult'),
            questions: document.getElementById('questionsResult'),
            unit: document.getElementById('unitResult'),
            transition: document.getElementById('transitionResult')
        };
        
        const resultTexts = {
            activity: document.getElementById('activityResultText'),
            communication: document.getElementById('commResultText'),
            story: document.getElementById('storyResultText'),
            summary: document.getElementById('summaryResultText'),
            support: document.getElementById('supportResultText'),
            lesson: document.getElementById('lessonResultText'),
            song: document.getElementById('songResultText'),
            observation: document.getElementById('observationResultText'),
            conflict: document.getElementById('conflictResultText'),
            objectives: document.getElementById('objectivesResultText'),
            questions: document.getElementById('questionsResultText'),
            unit: document.getElementById('unitResultText'),
            transition: document.getElementById('transitionResultText')
        };
        
        const loaders = {
            activity: document.getElementById('activityLoader'),
            communication: document.getElementById('commLoader'),
            story: document.getElementById('storyLoader'),
            summary: document.getElementById('summaryLoader'),
            support: document.getElementById('supportLoader'),
            lesson: document.getElementById('lessonLoader'),
            song: document.getElementById('songLoader'),
            observation: document.getElementById('observationLoader'),
            conflict: document.getElementById('conflictLoader'),
            objectives: document.getElementById('objectivesLoader'),
            questions: document.getElementById('questionsLoader'),
            unit: document.getElementById('unitLoader'),
            transition: document.getElementById('transitionLoader'),
            image: document.getElementById('imageLoader')
        };

        function copyTextToClipboard(text, button) {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.position = "fixed"; 
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try {
                document.execCommand('copy');
                const originalText = button.textContent;
                button.textContent = 'ุชู ุงููุณุฎ!';
                setTimeout(() => {
                    button.textContent = originalText;
                }, 2000);
            } catch (err) {
                console.error('Fallback: Oops, unable to copy', err);
            }
            document.body.removeChild(textArea);
        }

        document.querySelectorAll('.copy-btn').forEach(button => {
            button.addEventListener('click', (e) => {
                const textToCopy = e.target.closest('div[id$="Result"]').querySelector('pre').textContent;
                copyTextToClipboard(textToCopy, e.target);
            });
        });
        
        // --- Form Submission Logic ---

        forms.activity.addEventListener('submit', async (e) => {
            e.preventDefault();
            const activityType = document.getElementById('activityType').value;
            const activityTheme = document.getElementById('activityTheme').value;
            if (!activityTheme.trim()) { alert('ุงูุฑุฌุงุก ุฅุฏุฎุงู ููุถูุน ูููุดุงุท.'); return; }
            const { result, loader, resultText } = { result: results.activity, loader: loaders.activity, resultText: resultTexts.activity };
            result.classList.remove('hidden');
            loader.classList.remove('hidden');
            resultText.textContent = '';
            const systemPrompt = "ุฃูุช ูุฑุจูุฉ ุฃุทูุงู ุฎุจูุฑุฉ ููุจุฏุนุฉ. ูููุชู ูู ุงูุชุฑุงุญ ุฃูุดุทุฉ ุจุณูุทุฉ ูููุชุนุฉ ููุฃุทูุงู ุจุนูุฑ 3-5 ุณููุงุช. ูุฌุจ ุฃู ุชููู ุงูุงูุชุฑุงุญุงุช ูุงุถุญุฉุ ูุตูุฑุฉุ ูููุงุณุจุฉ ูุจูุฆุฉ ุฑูุถุฉ ุงูุฃุทูุงู.";
            const userQuery = `ุงูุชุฑุญ ูู ${activityType} ุญูู ููุถูุน "${activityTheme}". ูุฏู ุดุฑุญูุง ููุฌุฒูุง ููุฎุทูุงุช ูุงูููุงุฏ ุงููุงุฒูุฉ ุฅู ูุฌุฏุช.`;
            try {
                resultText.textContent = await generateTextWithRetry(systemPrompt, userQuery);
                e.target.reset();
            } catch (error) {
                resultText.textContent = 'ุนุฐุฑูุงุ ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุชูููุฏ ุงูููุฑุฉ. ุงูุฑุฌุงุก ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู.';
            } finally {
                loader.classList.add('hidden');
            }
        });
        
        forms.communication.addEventListener('submit', async(e) => {
            e.preventDefault();
            const commTone = document.getElementById('commTone').value;
            const commPoints = document.getElementById('commPoints').value;
            if (!commPoints.trim()) { alert('ุงูุฑุฌุงุก ุฅุฏุฎุงู ููุงุญุธุงุช ุนู ููู ุงูุทูู.'); return; }
            const { result, loader, resultText } = { result: results.communication, loader: loaders.communication, resultText: resultTexts.communication };
            result.classList.remove('hidden');
            loader.classList.remove('hidden');
            resultText.textContent = '';
            const systemPrompt = "ุฃูุช ูุณุงุนุฏ ููุนููุฉ ุฑูุงุถ ุฃุทูุงูุ ุชุชูุชุน ุจุงูุฎุจุฑุฉ ูุงููุทู. ูููุชู ูู ุตูุงุบุฉ ุฑุณุงุฆู ุงุญุชุฑุงููุฉ ูุฏุงูุฆุฉ ูุฃูููุงุก ุงูุฃููุฑ ุจุงููุบุฉ ุงูุนุฑุจูุฉ. ูุฌุจ ุฃู ุชููู ุงูุฑุณุงุฆู ููุฌุฒุฉ ูุฅูุฌุงุจูุฉ (ุญุชู ุนูุฏ ุฐูุฑ ุชุญุฏู ุจุณูุท)ุ ููุงุถุญุฉ.";
            const userQuery = `ุจูุงุกู ุนูู ุงูููุงุญุธุงุช ุงูุชุงููุฉ ุนู ููู ุงูุทูู: "${commPoints}"ุ ุงูุฑุฌุงุก ุตูุงุบุฉ ูุณูุฏุฉ ุฑุณุงูุฉ ูููู ุงูุฃูุฑ ุจูุจุฑุฉ "${commTone}".`;
            try {
                resultText.textContent = await generateTextWithRetry(systemPrompt, userQuery);
                e.target.reset();
            } catch (error) {
                resultText.textContent = 'ุนุฐุฑูุงุ ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุตูุงุบุฉ ุงูุฑุณุงูุฉ. ุงูุฑุฌุงุก ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู.';
            } finally {
                loader.classList.add('hidden');
            }
        });

        forms.story.addEventListener('submit', async(e) => {
            e.preventDefault();
            const character = document.getElementById('storyCharacter').value;
            const theme = document.getElementById('storyTheme').value;
            if (!theme.trim() || !character.trim()) { alert('ุงูุฑุฌุงุก ุฅุฏุฎุงู ุงุณู ุงูุดุฎุตูุฉ ูููุถูุน ุงููุตุฉ.'); return; }
            const { result, loader, resultText } = { result: results.story, loader: loaders.story, resultText: resultTexts.story };
            result.classList.remove('hidden');
            loader.classList.remove('hidden');
            document.getElementById('generateImageBtn').classList.add('hidden');
            document.getElementById('imageResult').classList.add('hidden');
            resultText.textContent = '';
            const systemPrompt = "ุฃูุช ูุงุชุจ ูุตุต ุฃุทูุงู ูุชุฎุตุต. ุงูุชุจ ูุตุฉ ูุตูุฑุฉ ุฌุฏุงู ูุจุณูุทุฉ (ุญูุงูู 4-6 ุฌูู) ููุฃุทูุงู ุจุนูุฑ 3-5 ุณููุงุช. ูุฌุจ ุฃู ุชููู ุงููุตุฉ ุฅูุฌุงุจูุฉ ูุฐุงุช ูุบุฒู ุจุณูุท.";
            const userQuery = `ุงูุชุจ ูุตุฉ ุนู ุดุฎุตูุฉ ุงุณููุง "${character}" ูููุถูุนูุง ูู "${theme}".`;
            try {
                const storyText = await generateTextWithRetry(systemPrompt, userQuery);
                resultText.textContent = storyText;
                document.getElementById('generateImageBtn').classList.remove('hidden');
                e.target.reset();
            } catch (error) {
                resultText.textContent = 'ุนุฐุฑูุงุ ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ูุชุงุจุฉ ุงููุตุฉ. ุงูุฑุฌุงุก ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู.';
            } finally {
                loader.classList.add('hidden');
            }
        });
        
        forms.summary.addEventListener('submit', async(e) => {
            e.preventDefault();
            const summaryPoints = document.getElementById('summaryPoints').value;
            if (!summaryPoints.trim()) { alert('ุงูุฑุฌุงุก ุฅุฏุฎุงู ูููุงุช ุฑุฆูุณูุฉ ูู ุฃูุดุทุฉ ุงูููู.'); return; }
            const { result, loader, resultText } = { result: results.summary, loader: loaders.summary, resultText: resultTexts.summary };
            result.classList.remove('hidden');
            loader.classList.remove('hidden');
            resultText.textContent = '';
            const systemPrompt = "ุฃูุช ูุนููุฉ ุฑูุงุถ ุฃุทูุงู ูุฑุญุฉ ููุญุจูุจุฉ. ูููุชู ูู ุตูุงุบุฉ ููุฎุต ูุตูุฑ ุฌุฏูุง ููุจุณุท ููุจูุฌ ูููุงูุฉ ุงูููู ุงูุฏุฑุงุณูุ ููุฌู ููุฃุทูุงู (ุนูุฑ 3-5 ุณููุงุช). ุงุณุชุฎุฏู ูุบุฉ ุจุณูุทุฉ ูุนุจุงุฑุงุช ุชุดุฌูุนูุฉ. ุงุจุฏุฃ ุฏุงุฆููุง ุจู 'ุฃุตุฏูุงุฆู ุงูุตุบุงุฑ ุงูุฑุงุฆุนูู!' ูุงุฎุชุชู ุจู 'ููุฏ ููุชู ูุฏูุดูู ุงูููู! ุฃุฑุงูู ุบุฏูุง.'";
            const userQuery = `ุงุณุชุฎุฏูู ูุฐู ุงูููุงุท ูุตูุงุบุฉ ุงูููุฎุต: "${summaryPoints}"`;
            try {
                resultText.textContent = await generateTextWithRetry(systemPrompt, userQuery);
                e.target.reset();
            } catch (error) {
                resultText.textContent = 'ุนุฐุฑูุงุ ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุฅูุดุงุก ุงูููุฎุต. ุงูุฑุฌุงุก ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู.';
            } finally {
                loader.classList.add('hidden');
            }
        });
        
        forms.lesson.addEventListener('submit', async (e) => {
            e.preventDefault();
            const lessonObjective = document.getElementById('lessonObjective').value;
            const lessonDuration = document.getElementById('lessonDuration').value;
            if (!lessonObjective.trim()) { alert('ุงูุฑุฌุงุก ุฅุฏุฎุงู ุงููุฏู ุงูุชุนูููู.'); return; }
            const { result, loader, resultText } = { result: results.lesson, loader: loaders.lesson, resultText: resultTexts.lesson };
            result.classList.remove('hidden');
            loader.classList.remove('hidden');
            resultText.textContent = '';
            const systemPrompt = "ุฃูุช ุฎุจูุฑ ูู ุชุตููู ุงูููุงูุฌ ููุชุนููู ุงููุจูุฑ (ุฃุนูุงุฑ 3-5 ุณููุงุช). ูููุชู ูู ุฅูุดุงุก ุฎุทุท ุฏุฑูุณ ูุตูุฑุฉุ ุชูุงุนููุฉุ ูููุงุณุจุฉ ูููู ุงูุฃุทูุงู. ุฑูุฒ ุนูู ุงูุชุนูู ูู ุฎูุงู ุงููุนุจ.";
            const userQuery = `ุจูุงุกู ุนูู ุงููุฏู ุงูุชุนูููู ุงูุชุงูู: "${lessonObjective}"ุ ูููุฏุฉ ุชูุฑูุจูุฉ "${lessonDuration}"ุ ูู ุจุฅูุดุงุก ุฎุทุฉ ุฏุฑุณ ุจุณูุทุฉ ุจุงููุบุฉ ุงูุนุฑุจูุฉ ููุณูุฉ ุฅูู ุซูุงุซุฉ ุฃูุณุงู ูุงุถุญุฉ: 1. ุงูุชููุฆุฉ (ูุฌุฐุจ ุงูุงูุชุจุงู)ุ 2. ุงููุดุงุท ุงูุฑุฆูุณู (ุงูุฎุทูุงุช ุงูุฑุฆูุณูุฉ)ุ 3. ุงูุฎุชุงู (ูููุฑุงุฌุนุฉ ูุงูุชูุฏุฆุฉ).`;
            try {
                resultText.textContent = await generateTextWithRetry(systemPrompt, userQuery);
                e.target.reset();
            } catch (error) {
                resultText.textContent = 'ุนุฐุฑูุงุ ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุฅูุดุงุก ุฎุทุฉ ุงูุฏุฑุณ. ุงูุฑุฌุงุก ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู.';
            } finally {
                loader.classList.add('hidden');
            }
        });

        forms.song.addEventListener('submit', async (e) => {
            e.preventDefault();
            const songTheme = document.getElementById('songTheme').value;
            if (!songTheme.trim()) { alert('ุงูุฑุฌุงุก ุฅุฏุฎุงู ููุถูุน ููุฃูุดูุฏุฉ.'); return; }
            const { result, loader, resultText } = { result: results.song, loader: loaders.song, resultText: resultTexts.song };
            result.classList.remove('hidden');
            loader.classList.remove('hidden');
            resultText.textContent = '';
            const systemPrompt = "ุฃูุช ุดุงุนุฑ ูููุญู ูุชุฎุตุต ูู ูุชุงุจุฉ ุฃุบุงูู ูุฃูุงุดูุฏ ุจุณูุทุฉ ูููุชุนุฉ ููุฃุทูุงู ุจุนูุฑ 3-5 ุณููุงุช. ูุฌุจ ุฃู ุชููู ุงููููุงุช ุณููุฉ ุงูุญูุธ ูุงููุญู ุงูููุชุฑุญ ุจุณูุทุงู ููุฑุญุงู. ูุฏู ุงูุฃูุดูุฏุฉ ูู ููุทุนูู ูุตูุฑูู.";
            const userQuery = `ุงูุชุจ ูู ุฃูุดูุฏุฉ ูุตูุฑุฉ ุญูู ููุถูุน "${songTheme}".`;
            try {
                resultText.textContent = await generateTextWithRetry(systemPrompt, userQuery);
                e.target.reset();
            } catch (error) {
                resultText.textContent = 'ุนุฐุฑูุงุ ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ูุชุงุจุฉ ุงูุฃูุดูุฏุฉ. ุงูุฑุฌุงุก ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู.';
            } finally {
                loader.classList.add('hidden');
            }
        });

        forms.observation.addEventListener('submit', async (e) => {
            e.preventDefault();
            const observationText = document.getElementById('observationText').value;
            if (!observationText.trim()) { alert('ุงูุฑุฌุงุก ุฅุฏุฎุงู ููุงุญุธุชู.'); return; }
            const { result, loader, resultText } = { result: results.observation, loader: loaders.observation, resultText: resultTexts.observation };
            result.classList.remove('hidden');
            loader.classList.remove('hidden');
            resultText.textContent = '';
            const systemPrompt = "ุฃูุช ุฎุจูุฑ ูู ุชุฑุจูุฉ ุงูุทูููุฉ ุงููุจูุฑุฉ ูุนูู ููุณ ุงูููู. ูููุชู ูู ุชุญููู ููุงุญุธุฉ ูุฎุชุตุฑุฉ ูุบูุฑ ุฑุณููุฉ ูู ูุนููุฉ ุฅูู ููุงุญุธุฉ ููููุฉ ููุธูุฉ. ูุฌุจ ุฃู ุชููู ุงูููุงุญุธุฉ ุฅูุฌุงุจูุฉุ ููุถูุนูุฉุ ูุชุฑุจุท ุงูุณููู ุงููุฑุตูุฏ ุจุฃุญุฏ ูุฌุงูุงุช ุงูููู ุฐุงุช ุงูุตูุฉ (ูุซุงู: ุงูููุงุฑุงุช ุงูุญุฑููุฉ ุงูุฏูููุฉุ ุงูุชุทูุฑ ุงููุนุฑููุ ุงูููุงุฑุงุช ุงูุงุฌุชูุงุนูุฉ ูุงูุนุงุทููุฉุ ุชุทูุฑ ุงููุบุฉ). ุญุงูุธ ุนูู ุฃู ูููู ุงููุงุชุฌ ููุฌุฒุงู ูููุณูุงู ุจูุถูุญ.";
            const userQuery = `ุจูุงุกู ุนูู ูุฐู ุงูููุงุญุธุฉ ุงููุฎุชุตุฑุฉ: "${observationText}"ุ ุงูุฑุฌุงุก ูุชุงุจุฉ ููุงุญุธุฉ ููููุฉ ููุธูุฉ ุชุชุถูู ูุตูุงู ููุณููู ูุชูุณูุฑุงู ูุฑุจุทู ุจุฃุญุฏ ูุฌุงูุงุช ุงูููู.`;
            try {
                resultText.textContent = await generateTextWithRetry(systemPrompt, userQuery);
                e.target.reset();
            } catch (error) {
                resultText.textContent = 'ุนุฐุฑูุงุ ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ูุนุงูุฌุฉ ุงูููุงุญุธุฉ. ุงูุฑุฌุงุก ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู.';
            } finally {
                loader.classList.add('hidden');
            }
        });
        
        forms.conflict.addEventListener('submit', async (e) => {
            e.preventDefault();
            const conflictDescription = document.getElementById('conflictDescription').value;
            if (!conflictDescription.trim()) { alert('ุงูุฑุฌุงุก ูุตู ุงููุฒุงุน.'); return; }
            const { result, loader, resultText } = { result: results.conflict, loader: loaders.conflict, resultText: resultTexts.conflict };
            result.classList.remove('hidden');
            loader.classList.remove('hidden');
            resultText.textContent = '';
            const systemPrompt = "ุฃูุช ููุฌู ุชุฑุจูู ุฎุจูุฑ ูู ุญู ุงููุฒุงุนุงุช ุจูู ุงูุฃุทูุงู ุงูุตุบุงุฑ (3-5 ุณููุงุช). ูููุชู ูู ุชูุฏูู ุฎุทูุงุช ุนูููุฉ ููุงุฏุฆุฉ ูููู ูููุนููุฉ ุงุณุชุฎุฏุงููุง ูุชุญููู ุงููุฒุงุน ุฅูู ูุฑุตุฉ ููุชุนูู ุงูุงุฌุชูุงุนู ูุงูุนุงุทูู. ุงุณุชุฎุฏู ูุบุฉ ุจุณูุทุฉ ูุฅูุฌุงุจูุฉ.";
            const userQuery = `ูุฏููุง ูุฐุง ุงููููู ูู ุงููุตู: "${conflictDescription}". ุงูุฑุฌุงุก ุชูุฏูู ุฎุทุฉ ุนูู ูู 3 ุฎุทูุงุช ุจุณูุทุฉุ ูุน ุฃูุซูุฉ ูุนุจุงุฑุงุช ูููููู ููููุง ููุฃุทูุงู.`;
            try {
                resultText.textContent = await generateTextWithRetry(systemPrompt, userQuery);
                e.target.reset();
            } catch (error) {
                resultText.textContent = 'ุนุฐุฑูุงุ ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุงูุชุฑุงุญ ุงูุญู. ุงูุฑุฌุงุก ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู.';
            } finally {
                loader.classList.add('hidden');
            }
        });
        
        forms.objectives.addEventListener('submit', async (e) => {
            e.preventDefault();
            const objectivesActivity = document.getElementById('objectivesActivity').value;
            if (!objectivesActivity.trim()) { alert('ุงูุฑุฌุงุก ูุตู ุงููุดุงุท.'); return; }
             const { result, loader, resultText } = { result: results.objectives, loader: loaders.objectives, resultText: resultTexts.objectives };
            result.classList.remove('hidden');
            loader.classList.remove('hidden');
            resultText.textContent = '';
            const systemPrompt = "ุฃูุช ุฎุจูุฑ ูู ุงูููุงูุฌ ุงูุชุฑุจููุฉ ููุชุนููู ุงูุฃูููุ ูุน ููู ุนููู ููุฅุทุงุฑ ุงููููุงุฌู ุงููุบุฑุจู. ูููุชู ูู ุชุญุฏูุฏ ุงูุฃูุฏุงู ุงูุชุฑุจููุฉ ุงูุฑุฆูุณูุฉ ุงูุชู ูููู ุชุญููููุง ูู ุฎูุงู ูุดุงุท ูุนูู.";
            const userQuery = `ุจุงููุณุจุฉ ูููุดุงุท ุงูุชุงูู: "${objectivesActivity}"ุ ุงูุฑุฌุงุก ุชุญุฏูุฏ 2-3 ุฃูุฏุงู ุชุฑุจููุฉ ุฃุณุงุณูุฉ ูููููุง ูุฐุง ุงููุดุงุท ูุฏู ุงูุฃุทูุงู. ูุฏููุง ูู ูุงุฆูุฉ ููุทูุฉ ูุงุถุญุฉ.`;
            try {
                resultText.textContent = await generateTextWithRetry(systemPrompt, userQuery);
                e.target.reset();
            } catch (error) {
                resultText.textContent = 'ุนุฐุฑูุงุ ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุชุญุฏูุฏ ุงูุฃูุฏุงู. ุงูุฑุฌุงุก ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู.';
            } finally {
                loader.classList.add('hidden');
            }
        });
        
        forms.questions.addEventListener('submit', async (e) => {
            e.preventDefault();
            const questionsTopic = document.getElementById('questionsTopic').value;
            if (!questionsTopic.trim()) { alert('ุงูุฑุฌุงุก ุฅุฏุฎุงู ุงูููุถูุน.'); return; }
            const { result, loader, resultText } = { result: results.questions, loader: loaders.questions, resultText: resultTexts.questions };
            result.classList.remove('hidden');
            loader.classList.remove('hidden');
            resultText.textContent = '';
            const systemPrompt = "ุฃูุช ูุฑุจูุฉ ุฃุทูุงู ูุงูุฑุฉ ูู ุฅุซุงุฑุฉ ูุถูู ุงูุฃุทูุงู ูุชุดุฌูุน ุงูุชูููุฑ ุงูููุฏู. ูููุชู ูู ุตูุงุบุฉ ุฃุณุฆูุฉ ููุชูุญุฉ ููุญูุฒุฉ ููุญูุงุฑ.";
            const userQuery = `ุญูู ููุถูุน ุฃู ูุดุงุท "${questionsTopic}"ุ ุงูุชุฑุญ 4-5 ุฃุณุฆูุฉ ููุชูุญุฉ ูููุงุณุจุฉ ููุฃุทูุงู (ุนูุฑ 3-5 ุณููุงุช) ูููููู ุงุณุชุฎุฏุงููุง ูุจุฏุก ุญูุงุฑ ูุนูู ูุชุนููู ููููู.`;
            try {
                resultText.textContent = await generateTextWithRetry(systemPrompt, userQuery);
                e.target.reset();
            } catch (error) {
                resultText.textContent = 'ุนุฐุฑูุงุ ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุชูููุฏ ุงูุฃุณุฆูุฉ. ุงูุฑุฌุงุก ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู.';
            } finally {
                loader.classList.add('hidden');
            }
        });
        
        forms.unit.addEventListener('submit', async (e) => {
            e.preventDefault();
            const theme = document.getElementById('unitTheme').value;
            const duration = document.getElementById('unitDuration').value;
            if (!theme.trim()) { alert('ุงูุฑุฌุงุก ุฅุฏุฎุงู ููุถูุน ูููุญุฏุฉ.'); return; }
            const { result, loader, resultText } = { result: results.unit, loader: loaders.unit, resultText: resultTexts.unit };
            result.classList.remove('hidden');
            loader.classList.remove('hidden');
            resultText.textContent = '';
            const systemPrompt = "ุฃูุช ุฎุจูุฑ ูู ุชุฎุทูุท ุงูููุงูุฌ ููุชุนููู ุงูุฃููู. ูููุชู ูู ุฅูุดุงุก ุฎุทุท ูุญุฏุงุช ุฏุฑุงุณูุฉ ูุชูุงููุฉ ูููุชุนุฉ ููุฃุทูุงู ุจุนูุฑ 3-5 ุณููุงุชุ ุชุฑุชูุฒ ุนูู ุงูุชุนูู ุนุจุฑ ุงููุนุจ ูุงูุงุณุชูุดุงู.";
            const userQuery = `ุจูุงุกู ุนูู ุงูููุถูุน ุงูุชุงูู: "${theme}"ุ ูููุฏุฉ "${duration}"ุ ูู ุจุฅูุดุงุก ูุฎุทุท ูุญุฏุฉ ุฏุฑุงุณูุฉ. ูุฌุจ ุฃู ูุชุถูู ุงููุฎุทุท ุงูุชุฑุงุญุงุช ููููุฉ ูุฃูุดุทุฉ ุฑุฆูุณูุฉุ ูุฃููุงุฑุงู ูุฃุนูุงู ูููุฉุ ููุตุฉ ููุชุฑุญุฉุ ูุฃูุดูุฏุฉุ ูุจุนุถ ุงูููุฑุฏุงุช ุงูุฃุณุงุณูุฉ ุงููุชุนููุฉ ุจุงูููุถูุน.`;
            try {
                resultText.textContent = await generateTextWithRetry(systemPrompt, userQuery);
                e.target.reset();
            } catch (error) {
                resultText.textContent = 'ุนุฐุฑูุงุ ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุฅูุดุงุก ุงููุฎุทุท. ุงูุฑุฌุงุก ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู.';
            } finally {
                loader.classList.add('hidden');
            }
        });


        const getScheduleAsText = () => {
            // This function is no longer needed as the schedule is removed, but we keep it for the support modal
            return "ุฌุฏูู ูููู ูุชุถูู ุงุณุชูุจุงูุ ุฃูุดุทุฉุ ุงุณุชุฑุงุญุฉุ ูุฏุงุน.";
        };


        forms.support.addEventListener('submit', async (e) => {
            e.preventDefault();
            const supportNeeds = document.getElementById('supportNeeds').value;
            if (!supportNeeds.trim()) { alert('ุงูุฑุฌุงุก ูุตู ุงุญุชูุงุฌ ุงูุทูู.'); return; }
            const { result, loader, resultText } = { result: results.support, loader: loaders.support, resultText: resultTexts.support };
            result.classList.remove('hidden');
            loader.classList.remove('hidden');
            resultText.textContent = '';
            const scheduleContext = getScheduleAsText();
            const systemPrompt = "ุฃูุช ุฎุจูุฑ ูู ุชุฑุจูุฉ ุงูุทูููุฉ ุงููุจูุฑุฉ ูุนูู ููุณ ุงูููู. ูููุชู ูู ุชูุฏูู ุชูุตูุงุช ูุฎุตุตุฉ ูุชูููู ุฌุฏูู ุฏุฑุงุณู ูููู ูุชูุจูุฉ ุงุญุชูุงุฌุงุช ุทูู ูุนูู. ูุฌุจ ุฃู ุชููู ุงูุงูุชุฑุงุญุงุช ุนูููุฉ ููุงุจูุฉ ููุชูููุฐ ูู ุจูุฆุฉ ุงููุตู ุงูุฏุฑุงุณู.";
            const userQuery = `ุจุงููุธุฑ ุฅูู ุฌุฏูู ูููู ููุงุณูุ ุงูุฑุฌุงุก ุงูุชุฑุงุญ 3-4 ุชุนุฏููุงุช ุจุณูุทุฉ ูุนูููุฉ ูุฏุนู ุทูู ูุฏูู ุงูุงุญุชูุงุฌุงุช ุงูุชุงููุฉ ุจุดูู ุฃูุถู: "${supportNeeds}". ูุฏู ุงูุงูุชุฑุงุญุงุช ููุงุฆูุฉ ููุทูุฉ ูุงุถุญุฉ ุจุงููุบุฉ ุงูุนุฑุจูุฉ.`;
            try {
                resultText.textContent = await generateTextWithRetry(systemPrompt, userQuery);
                e.target.reset();
            } catch (error) {
                resultText.textContent = 'ุนุฐุฑูุงุ ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุฅูุดุงุก ุงูุฎุทุฉ. ุงูุฑุฌุงุก ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู.';
            } finally {
                loader.classList.add('hidden');
            }
        });
        
        forms.transition.addEventListener('submit', async(e) => {
            e.preventDefault();
            const transitionDescription = document.getElementById('transitionDescription').value;
            if (!transitionDescription.trim()) { alert('ุงูุฑุฌุงุก ูุตู ุงููููู ุงูุงูุชูุงูู.'); return; }
            const { result, loader, resultText } = { result: results.transition, loader: loaders.transition, resultText: resultTexts.transition };
            result.classList.remove('hidden');
            loader.classList.remove('hidden');
            resultText.textContent = '';
            const systemPrompt = "ุฃูุช ูุฑุจูุฉ ุฃุทูุงู ุฎุจูุฑุฉ ููุชุฎุตุตุฉ ูู ุฅุฏุงุฑุฉ ุงููุตู ุงูุฏุฑุงุณู ุงูุฅูุฌุงุจูุฉ. ูููุชู ูู ุชูุฏูู ุฃููุงุฑ ูุตูุฑุฉ ููุจุชูุฑุฉ ููุฑุญุฉ ูุฌุนู ูุชุฑุงุช ุงูุงูุชูุงู ุจูู ุงูุฃูุดุทุฉ ุณูุณุฉ ูููุชุนุฉ ููุฃุทูุงู ุจุนูุฑ 3-5 ุณููุงุช.";
            const userQuery = `ุฃุญุชุงุฌ ููุฑุฉ ููุงูุชูุงู ูู "${transitionDescription}". ุงูุชุฑุญ ูุนุจุฉ ุณุฑูุนุฉ ุฃู ุฃุบููุฉ ูุตูุฑุฉ ุฃู ุชุนูููุงุช ุฅุจุฏุงุนูุฉ.`;
            try {
                resultText.textContent = await generateTextWithRetry(systemPrompt, userQuery);
                e.target.reset();
            } catch (error) {
                resultText.textContent = 'ุนุฐุฑูุงุ ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุงูุชุฑุงุญ ุงูููุฑุฉ. ุงูุฑุฌุงุก ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู.';
            } finally {
                loader.classList.add('hidden');
            }
        });


        document.getElementById('generateImageBtn').addEventListener('click', async () => {
            const storyText = resultTexts.story.textContent;
            if (!storyText) return;

            document.getElementById('imageResult').classList.remove('hidden');
            loaders.image.classList.remove('hidden');
            document.getElementById('storyImage').src = '';
            document.getElementById('generateImageBtn').disabled = true;

            const promptGenSystemPrompt = "You are an expert prompt engineer for AI image generation models. Your task is to create a simple, effective prompt based on a short children's story.";
            const promptGenUserQuery = `From the following children's story, create a simple image prompt. The prompt should describe the main scene or character in a 'simple, colorful, and friendly cartoon illustration style for a children's book'. Story: "${storyText}"`;

            try {
                const imagePrompt = await generateTextWithRetry(promptGenSystemPrompt, userQuery);
                const base64Data = await generateImageWithRetry(imagePrompt);
                document.getElementById('storyImage').src = `data:image/png;base64,${base64Data}`;
            } catch(error) {
                console.error("Error generating image:", error);
                alert("ุนุฐุฑูุงุ ูู ูุชููู ูู ุชูููุฏ ุงูุตูุฑุฉ.");
            } finally {
                loaders.image.classList.add('hidden');
                document.getElementById('generateImageBtn').disabled = false;
            }
        });
        
        async function generateImageWithRetry(prompt, retries = 3, delay = 1000) {
             for (let i = 0; i < retries; i++) {
                try {
                    const payload = { instances: [{ prompt: prompt }], parameters: { "sampleCount": 1 } };
                    const response = await fetch(imageApiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (!response.ok) throw new Error(`API request failed with status ${response.status}`);
                    
                    const result = await response.json();
                    if (result.predictions && result.predictions.length > 0 && result.predictions[0].bytesBase64Encoded) {
                        return result.predictions[0].bytesBase64Encoded;
                    } else {
                        throw new Error('Invalid image response structure');
                    }
                } catch (error) {
                    console.error(`Image generation attempt ${i + 1} failed:`, error);
                    if (i < retries - 1) {
                        await new Promise(res => setTimeout(res, delay * Math.pow(2, i)));
                    } else {
                        throw error;
                    }
                }
            }
        }
        
        async function generateTextWithRetry(systemPrompt, userQuery, retries = 3, delay = 1000) {
            for (let i = 0; i < retries; i++) {
                try {
                    const payload = {
                        contents: [{ parts: [{ text: userQuery }] }],
                        systemInstruction: { parts: [{ text: systemPrompt }] },
                    };
                    const response = await fetch(textApiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) throw new Error(`API request failed with status ${response.status}`);
                    
                    const result = await response.json();
                    const candidate = result.candidates?.[0];
                    if (candidate && candidate.content?.parts?.[0]?.text) {
                        return candidate.content.parts[0].text;
                    } else {
                        throw new Error('Invalid response structure from API');
                    }
                } catch (error) {
                    console.error(`Text generation attempt ${i + 1} failed:`, error);
                    if (i < retries - 1) {
                        await new Promise(res => setTimeout(res, delay * Math.pow(2, i)));
                    } else {
                        throw error;
                    }
                }
            }
        }
    </script>
</body>
</html>

