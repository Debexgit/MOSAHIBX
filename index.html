<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مصاحب: مساعدك التربوي الذكي</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Cairo', sans-serif;
            direction: rtl;
            background-color: #f8fafc;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #14b8a6;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .tool-card {
            transition: all 0.3s ease;
            border: 1px solid #e5e7eb;
        }
        .tool-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            border-color: #14b8a6;
        }
        .mobile-scroll::-webkit-scrollbar {
            display: none;
        }
        .mobile-scroll {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .tool-group h3 {
            margin-bottom: 1rem;
            font-size: 1.125rem;
            font-weight: 700;
            color: #374151;
            border-bottom: 2px solid #e5e7eb;
            padding-bottom: 0.5rem;
        }
    </style>
</head>
<body class="bg-slate-50 text-gray-800">

    <div id="app" class="container mx-auto max-w-6xl p-4 sm:p-6 md:p-8">
        
        <div id="main-app-view">
             <header class="text-center mb-12">
                <h1 class="text-4xl md:text-6xl font-extrabold text-gray-900 leading-tight">مصاحب</h1>
                <h2 class="text-2xl md:text-3xl font-bold text-teal-600 mt-2">مساعدك التربوي الذكي</h2>
                <p class="mt-4 text-lg text-gray-600 max-w-2xl mx-auto">أدوات ذكية بين يديك لتسهيل مهامك التربوية اليومية.</p>
            </header>

            <main>
                <section id="gemini-assistant">
                    <div class="bg-white rounded-2xl shadow-xl p-6 md:p-8">
                        <div class="mb-8">
                            <h2 class="text-3xl font-bold text-teal-600 mb-4 text-center">🤖 اختر أداتك الذكية</h2>
                            <div class="relative w-full max-w-xl mx-auto">
                                <input type="text" id="search-tools" placeholder="ابحث عن أداة..." class="w-full p-3 pr-10 text-gray-700 bg-gray-100 rounded-full focus:outline-none focus:ring-2 focus:ring-teal-500">
                                <span class="absolute top-1/2 right-3 -translate-y-1/2 text-gray-400 text-2xl">🔍</span>
                            </div>
                        </div>
                        
                        <div id="tools-container" class="hidden md:grid md:grid-cols-2 lg:grid-cols-4 gap-8">
                        </div>
                        <div id="mobile-tools-container" class="md:hidden flex overflow-x-auto snap-x snap-mandatory gap-4 mobile-scroll pb-4">
                        </div>
                    </div>
                </section>
            </main>
             <footer class="text-center mt-16 pt-8 border-t border-gray-200">
                <p class="text-gray-600 font-semibold">Debex &copy; 2025</p>
            </footer>
        </div>

        <div id="modals-container"></div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // ===================================================================
            // ====================>   الرجاء وضع مفتاح API هنا   <===================
            // ===================================================================
            const apiKey = "AIzaSyDxFiTACc_-KTnS0Ai8y5Gzex8lL59wX_4"; // IMPORTANT: Add your Gemini API Key here. For example: "AIzaSy..."
            // ===================================================================

            const textApiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            
            const toolsData = {
                "التخطيط": {
                    color: "blue",
                    tools: [
                        { id: "unit", icon: "📅", name: "مخطط الوحدات", desc: "خطط لوحدة دراسية كاملة." },
                        { id: "lesson", icon: "✨", name: "مخطط الدروس", desc: "جهز لدرسك في دقائق." },
                        { id: "objectives", icon: "🎯", name: "مساعد الأهداف", desc: "حدد أهدافاً تربوية واضحة." },
                        { id: "corners", icon: "🧩", name: "مقترح الأركان", desc: "أفكار إبداعية لأركان فصلك." }
                    ]
                },
                "إنشاء المحتوى": {
                     color: "green",
                     tools: [
                        { id: "activity", icon: "💡", name: "مولّد الأنشطة", desc: "احصل على أفكار أنشطة جديدة." },
                        { id: "story", icon: "📖", name: "مولّد القصص", desc: "اكتب قصصاً مخصصة للأطفال." },
                        { id: "song", icon: "🎶", name: "مولّد الأناشيد", desc: "ألّف أناشيد تعليمية بسهولة." },
                        { id: "questions", icon: "🤔", name: "مولّد الأسئلة", desc: "اطرح أسئلة تثير الفضول." },
                        { id: "flashcard", icon: "📇", name: "منشئ البطاقات", desc: "جهز بطاقات كلمات تعليمية." }
                     ]
                },
                "إدارة الفصل": {
                     color: "yellow",
                     tools: [
                        { id: "transition", icon: "🚀", name: "مساعد الانتقالات", desc: "نظم الفترات الانتقالية." },
                        { id: "conflict", icon: "🗣️", name: "مساعد النزاعات", desc: "حوّل النزاعات لفرص تعلم." },
                        { id: "roleplay", icon: "🎭", name: "لعب الأدوار", desc: "علّم المهارات الاجتماعية." },
                        { id: "differentiation", icon: "🔧", name: "مكيف الأنشطة", desc: "كيّف الأنشطة لمختلف المستويات." },
                        { id: "support", icon: "🤝", name: "الدعم الفردي", desc: "ضع خطط دعم مخصصة." }
                     ]
                },
                 "المتابعة والتواصل": {
                     color: "purple",
                     tools: [
                        { id: "observation", icon: "📋", name: "تدوين الملاحظات", desc: "حوّل ملاحظاتك لتقارير." },
                        { id: "communication", icon: "✉️", name: "رسائل للأهل", desc: "تواصل بفعالية مع الآباء." },
                        { id: "parent", icon: "🏡", name: "أنشطة منزلية", desc: "عزز التعلم في المنزل." },
                        { id: "summary", icon: "📝", name: "ملخص اليوم", desc: "لخص يوم الأطفال بإيجابية." }
                     ]
                }
            };

            const colors = {
                blue: { border: "border-blue-500", text: "text-blue-600" },
                green: { border: "border-green-500", text: "text-green-600" },
                yellow: { border: "border-yellow-500", text: "text-yellow-600" },
                purple: { border: "border-purple-500", text: "text-purple-600" },
            };

            function generateAllModals() {
                const modalsContainer = document.getElementById('modals-container');
                let allModalsHTML = '';

                Object.values(toolsData).forEach(group => {
                    group.tools.forEach(tool => {
                        allModalsHTML += `
                            <div data-modal-id="${tool.id}" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center p-4 z-50">
                                <div class="bg-white rounded-lg shadow-2xl w-full max-w-lg p-6 relative">
                                    <button data-close-button class="absolute top-3 right-3 text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
                                    <h3 class="text-2xl font-bold text-center mb-4 text-teal-600 flex items-center justify-center gap-3">${tool.icon} ${tool.name}</h3>
                                    <form id="${tool.id}Form">
                                        <div class="mb-6">
                                            <label for="${tool.id}Input" class="block text-gray-700 text-sm font-bold mb-2">أدخل طلبك هنا:</label>
                                            <textarea id="${tool.id}Input" rows="4" class="shadow-sm appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-teal-500" placeholder="${tool.desc}"></textarea>
                                        </div>
                                        <div class="text-center">
                                            <button type="submit" class="bg-teal-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-teal-600 transition-colors">
                                                ✨ توليد
                                            </button>
                                        </div>
                                    </form>
                                    <div id="${tool.id}Result" class="mt-6 hidden">
                                        <div class="flex justify-between items-center mb-2">
                                            <h4 class="text-xl font-bold text-gray-800">النتيجة:</h4>
                                            <button class="copy-btn bg-slate-200 text-slate-700 text-sm py-1 px-3 rounded-md hover:bg-slate-300">نسخ النص</button>
                                        </div>
                                        <div id="${tool.id}Loader" class="loader mx-auto my-4 hidden"></div>
                                        <pre id="${tool.id}ResultText" class="bg-slate-100 p-4 rounded-lg whitespace-pre-wrap text-right font-sans h-48 overflow-y-auto"></pre>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                });
                modalsContainer.innerHTML = allModalsHTML;
            }
            
            function copyTextToClipboard(text, button) {
                const textArea = document.createElement("textarea");
                textArea.value = text;
                textArea.style.position = "fixed"; 
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                try {
                    document.execCommand('copy');
                    const originalText = button.textContent;
                    button.textContent = 'تم النسخ!';
                    setTimeout(() => {
                        button.textContent = originalText;
                    }, 2000);
                } catch (err) {
                    console.error('Fallback: Oops, unable to copy', err);
                }
                document.body.removeChild(textArea);
            }

            function attachEventListeners() {
                document.querySelectorAll('[data-modal]').forEach(button => {
                    button.addEventListener('click', () => {
                        const modalId = button.dataset.modal;
                        const targetModal = document.querySelector(`[data-modal-id="${modalId}"]`);
                        if (targetModal) {
                            targetModal.classList.remove('hidden');
                            targetModal.classList.add('flex');
                        }
                    });
                });

                document.querySelectorAll('[data-close-button]').forEach(button => {
                    button.addEventListener('click', () => {
                        button.closest('[data-modal-id]').classList.add('hidden');
                        button.closest('[data-modal-id]').classList.remove('flex');
                    });
                });
                
                document.querySelectorAll('form').forEach(form => {
                   form.addEventListener('submit', (e) => handleFormSubmit(e));
                });

                document.querySelectorAll('.copy-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const textToCopy = e.target.closest('div[id$="Result"]').querySelector('pre').textContent;
                        copyTextToClipboard(textToCopy, e.target);
                    });
                });
            }

            function renderTools(filter = '') {
                const desktopContainer = document.getElementById('tools-container');
                const mobileContainer = document.getElementById('mobile-tools-container');
                desktopContainer.innerHTML = '';
                mobileContainer.innerHTML = '';

                for (const groupName in toolsData) {
                    const group = toolsData[groupName];
                    const filteredTools = group.tools.filter(tool => tool.name.includes(filter) || tool.desc.includes(filter));
                    
                    if (filteredTools.length === 0) continue;

                    let toolsHTML = '';
                    filteredTools.forEach(tool => {
                        toolsHTML += `
                            <button data-modal="${tool.id}" class="w-full text-right p-4 rounded-lg bg-slate-50 hover:bg-slate-100 tool-card">
                                <div class="flex items-center gap-4">
                                    <span class="text-4xl">${tool.icon}</span>
                                    <div>
                                        <h4 class="font-bold text-lg text-gray-800">${tool.name}</h4>
                                        <p class="text-sm text-gray-500">${tool.desc}</p>
                                    </div>
                                </div>
                            </button>
                        `;
                    });

                    const desktopGroupHTML = `
                        <div class="tool-group">
                            <h3 class="border-b-2 ${colors[group.color].border} ${colors[group.color].text}">${groupName}</h3>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-4">
                                ${toolsHTML}
                            </div>
                        </div>`;
                    
                    const mobileGroupHTML = `
                        <div class="tool-group snap-start flex-shrink-0 w-[85%] sm:w-1/2">
                            <h3 class="border-b-2 ${colors[group.color].border} ${colors[group.color].text}">${groupName}</h3>
                            <div class="grid grid-cols-1 gap-4 mt-4">
                                ${toolsHTML}
                            </div>
                        </div>`;

                     desktopContainer.innerHTML += desktopGroupHTML;
                     mobileContainer.innerHTML += mobileGroupHTML;
                }
                attachEventListeners();
            }
            
            document.getElementById('search-tools').addEventListener('input', (e) => {
                renderTools(e.target.value);
            });
            
            async function handleFormSubmit(e) {
                e.preventDefault();
                const form = e.target;
                const toolId = form.id.replace('Form', '');
                const inputEl = form.querySelector('textarea, input, select');
                const input = inputEl.value;

                if (!input.trim()) {
                    alert('الرجاء إدخال طلبك.');
                    return;
                }
                
                const resultContainer = document.getElementById(`${toolId}Result`);
                const loader = document.getElementById(`${toolId}Loader`);
                const resultTextEl = document.getElementById(`${toolId}ResultText`);

                resultContainer.classList.remove('hidden');
                loader.classList.remove('hidden');
                resultTextEl.textContent = '';

                // This is a generic prompt. In a real app, you would have specific system prompts per tool.
                const systemPrompt = "أنت مساعد تربوي متخصص في التعليم الأولي. قدم إجابات مفيدة ومبتكرة ومناسبة للأطفال الصغار والمربيات.";
                
                try {
                    const resultText = await generateTextWithRetry(systemPrompt, input);
                    resultTextEl.textContent = resultText;
                    form.reset();
                } catch (error) {
                    resultTextEl.textContent = 'عذرًا، حدث خطأ. الرجاء المحاولة مرة أخرى.';
                } finally {
                    loader.classList.add('hidden');
                }
            }

            async function generateTextWithRetry(systemPrompt, userQuery, retries = 3, delay = 1000) {
                if (!apiKey) {
                    return "خطأ: مفتاح API الخاص بـ Gemini غير موجود. يرجى إضافته في الكود.";
                }
                for (let i = 0; i < retries; i++) {
                    try {
                        const payload = {
                            contents: [{ parts: [{ text: userQuery }] }],
                            systemInstruction: { parts: [{ text: systemPrompt }] },
                        };
                        const response = await fetch(textApiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        if (!response.ok) {
                             const errorBody = await response.json();
                             console.error("API Error:", errorBody);
                             throw new Error(`API request failed with status ${response.status}`);
                        }
                        
                        const result = await response.json();
                        const candidate = result.candidates?.[0];
                        if (candidate && candidate.content?.parts?.[0]?.text) {
                            return candidate.content.parts[0].text;
                        } else {
                            console.warn("Unexpected API response structure:", result);
                            if(candidate && candidate.finishReason !== 'STOP'){
                                return `تم حظر الطلب. السبب: ${candidate.finishReason}`;
                            }
                            throw new Error('Invalid response structure from API');
                        }
                    } catch (error) {
                        console.error(`Text generation attempt ${i + 1} failed:`, error);
                        if (i < retries - 1) {
                            await new Promise(res => setTimeout(res, delay * Math.pow(2, i)));
                        } else {
                           throw error;
                        }
                    }
                }
            }

            // --- Initial Setup ---
            generateAllModals();
            renderTools();
        });
    </script>

</body>
</html>
